### <u>方案设计</u>

MUP6050会产生中断（5ms或者10ms），

其实就是MPU的INT引脚发出一个信号，被STM32捕捉到，

然后stm32在这个中段里完成PID算法对小车姿态和速度进行调整

​    包括：编码器读取速度和方向，MPU读取姿态，倾斜角度，调用PID算法调整 

##### 直流马达--》TB6612--》STM32

左右两个马达，左马达motorA，右马达motorB，需要六个IO，两个定时器通道，暂定TIM1_CH1和TIM4_CH4,   PB0 1 6 8

#### 编码器-》STM32

4个IO

#### MPU6050--》stm32

IIC通信，还需要一个IO来产生中断，3个IO，**注意！！！<u>杜邦线要尽可能的短</u>**

#### 电池-降压--stm32供电

正负极要注意不能接反

#### 蓝牙--》stm32

串口通信PA2  PA3 两个IO

### 按钮-》

控制小车启动与停止

##### 后期考虑

#### 超声波避障

两个IO，需要用到一个外部中断

#### 舵机转向

1个IO产生PWM控制角度





中断初始化  

----电机PWM初始化（TIM1）（PA8、9/11）     PC0123                                                                                                                                                                     

----串口3初始化，写串口3接收中断服务函数（PB10、11）（TX-RX）

​	（其实就是蓝牙，蓝牙在收到数据后，和STM32之间利用串口通信，将其连接在串口3上，设置接收中断，在中断中分析接收到的信号，在做出相应的改变）

------编码器初始化（TIM2TIM4）（PA0、1）（PB6、7）

-----IIC初始化，软件/硬件IIC，用来传输MPU数据（PB8、9）

---------------MPU初始化，DMP（mpu库文件）初始化（）

------超声波初始化（TIM3）（PB0、1）（EO、TR）

------我们用到了MPU的中断，所以在STM32上写一个外部中断服务函数来接受MPU每10ms产生的一个中断，并在这个中断中做事情

------MPU外部中断服务函数：（PB5）

​			清除标志位

​			获得角度

​			获得编码器的值（即速度和方向）

​			超声波或的距离

​			直立PD算法（角度，角速度）  return 直立控制PWM

​			速度PI算法（左右编码器数值）	

​			转向算法		

​			根据以上三者，计算左右轮子PWM，并赋值



​				





引脚接法

左电机 m1-  A02 pa4  m1+ A01 pa5   pwma---PA8

右电机 m2- B02 pba2 m2+ B01 pa3  pwmb---PA9--T

编码器左   e1a  pa1 e1b pa0----over

编码器右  e2a pb6 e2b pb7		------over

蓝牙  主机     over

txd----rxd pb11 

rxd----txd pb10			

mpu  scl--pb8  sda--pb9  int pb5   --over

led + pa15   over

超声波 TR--pb0  EC--pb1   over

